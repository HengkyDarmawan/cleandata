(function($) {
    $.fn.superWheel = function(options) {
        var settings = $.extend({
            slices: [],
            duration: 8000
        }, options);

        var $this = $(this);
        var canvasId = 'wheelCanvas';
        $this.html('<canvas id="' + canvasId + '" width="400" height="400"></canvas>');
        var canvas = document.getElementById(canvasId);
        var ctx = canvas.getContext('2d');
        var centerX = canvas.width / 2;
        var centerY = canvas.height / 2;
        var radius = canvas.width / 2;

        // Menggambar Potongan Roda
        function drawWheel() {
            var sliceAngle = (2 * Math.PI) / settings.slices.length;
            settings.slices.forEach(function(slice, i) {
                ctx.beginPath();
                ctx.fillStyle = slice.background;
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, i * sliceAngle, (i + 1) * sliceAngle);
                ctx.fill();

                // Gambar Teks
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(i * sliceAngle + sliceAngle / 2);
                ctx.fillStyle = "#fff";
                ctx.font = "bold 12px Arial";
                ctx.fillText(slice.text.substring(0, 15), 70, 5);
                ctx.restore();
            });
        }

        drawWheel();

        // Fungsi Start (Trigger dari Tombol Spin)
        this.start = function(type, value) {
            var sliceIndex = settings.slices.findIndex(s => s.value == value);
            var degPerSlice = 360 / settings.slices.length;
            var stopDeg = 3600 + (360 - (sliceIndex * degPerSlice)) - (degPerSlice / 2);
            
            $this.trigger('atStart');
            $this.css('transform', 'rotate(' + stopDeg + 'deg)');

            setTimeout(function() {
                var winner = settings.slices[sliceIndex];
                $this.trigger('atComplete', [winner]);
            }, settings.duration);
        };

        // Membungkus method agar bisa dipanggil via $('.wheel').superWheel('start', ...)
        if (typeof options === 'string') {
            if (options === 'start') {
                this.start(arguments[1], arguments[2]);
            }
        }

        return this;
    };
})(jQuery);